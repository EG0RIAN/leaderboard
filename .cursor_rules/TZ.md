Техническое задание: Telegram Mini App “Лидерборд донатов + рефералы”

1. Цель и бизнес-логика

Создать Telegram Mini App, в котором:
	1.	Пользователь видит лидерборды по донатам (в “тонах”).
	2.	Может пополнить донат через Telegram Stars (с предустановками и произвольной суммой).
	3.	Может привлекать пользователей по реферальной ссылке и получать место в лидерборде рефералов по сумме донатов приглашённых.

2. Стек и компоненты

2.1 Backend
	•	Python, async
	•	aioGram (бот-слой)
	•	HTTP API (FastAPI / aiohttp — допускается любой async-совместимый вариант)
	•	Хранилище: PostgreSQL (рекомендуется) / SQLite (на dev), миграции Alembic

2.2 Frontend (Mini App)
	•	Telegram Web Apps SDK (инициализация, получение user, share, UI интеграции)
	•	UI: Liquid UI
	•	Архитектура: SPA (роутинг 3 вкладки)

2.3 Платежи
	•	Telegram Stars (инвойсы, подтверждение оплаты через события/хэндлеры бота)
	•	Идемпотентность по платежам обязательна

3. Роли
	•	Пользователь: просматривает лидерборды, донатит, делится реф-ссылкой.
	•	(Опционально) Администратор: настройка курсов/пакетов/лимитов, просмотр статистики.

4. Термины и определения
	•	Stars — валюта оплаты внутри Telegram.
	•	Тоны — внутренняя “валюта лидерборда”, начисляется пользователю пропорционально Stars по курсу.
	•	Реферер — пользователь, пригласивший нового пользователя.
	•	Реферал — приглашённый пользователь, который впервые открыл Mini App по реф-ссылке.

5. Экраны и UX

5.1 Общая структура

Верх: табы (3 вкладки):
	1.	За всё время
	2.	За неделю
	3.	Топ рефералов

Низ: фиксированная кнопка «Пополнить» (на всех вкладках).

Общее:
	•	Список топ-N (например, 50) + пагинация/“Показать ещё”.
	•	Отображение “моего места” (опционально) — блок “Вы: #X”.

⸻

5.2 Вкладка 1: “За всё время”

Данные: сумма тонов пользователя за весь период.
Сортировка: по убыванию total_tons_all_time.
Элемент списка:
	•	#позиция
	•	аватар + username/first_name
	•	сумма (тоны)

⸻

5.3 Вкладка 2: “За неделю”

Данные: сумма тонов пользователя за текущую календарную неделю.
Правило недели: календарная неделя (ISO-логика допустима), фиксируем TZ = Europe/Berlin (или настройка проекта).
Сортировка: по убыванию total_tons_week.

⸻

5.4 Вкладка 3: “Топ рефералов”

Отображаются пользователи-рефереры, ранжирование по суммарным донатам их рефералов.

Метрики по рефереру:
	•	total_referrals_count (кол-во новых рефералов, закреплённых за реферером)
	•	total_referrals_tons_all_time (тоны, задоначенные всеми его рефералами за всё время)
	•	(опционально) total_referrals_tons_week

Сортировка: по убыванию total_referrals_tons_all_time (или отдельный переключатель “неделя/всё время” — опционально).

Кнопка: «Приведи друга»
	•	По нажатию: открываем нативный шаринг в Telegram с текстом:
	•	Короткий CTA
	•	ссылка на Mini App с параметром ref=<tg_id> (см. раздел 6)

⸻

6. Реферальная механика

6.1 Формат реф-ссылки

Реферальный параметр = Telegram ID пользователя (реферера).
Рекомендуемый формат:
	•	deep link на бота/миниапп, например startapp=ref_<tg_id> (конкретный формат зависит от выбранного способа открытия Mini App)
	•	в Mini App при старте читаем initData/start params и вытаскиваем ref_code.

6.2 Правило закрепления реферера

Реферер фиксируется только при первом появлении пользователя в базе:
	•	Если пользователь новый: записать referrer_id = ref_code (если ref_code валиден и не равен самому себе).
	•	Если пользователь уже существует: referrer_id не меняем, реферал не засчитывается.

6.3 Учет донатов рефералов

Донаты пользователя учитываются в сумме “его рефереру” только если:
	•	этот пользователь был закреплён как новый реферал при первом входе.

Если пользователь был в базе раньше и referrer_id не установлен на этого реферера — донаты не добавляются.

⸻

7. Донат и платежный сценарий (Stars)

7.1 Кнопка “Пополнить”

Открывает модалку выбора:
	•	Пакет “1 место”
	•	Пакет “2 место”
	•	Пакет “3 место”
	•	Своя сумма (в Stars)

Пакеты = предустановленные суммы Stars (числа задаются конфигом в админке/ENV/таблице settings).

7.2 Создание инвойса

При выборе суммы:
	1.	фронт вызывает backend POST /payments/create_invoice с amount_stars и контекстом (user_id, type=donation, optional: preset_id)
	2.	backend формирует invoice через Telegram API (Stars)
	3.	фронт открывает оплату (Telegram Web Apps / invoice flow)

7.3 Подтверждение оплаты

Оплата считается успешной только после подтверждения событием со стороны бота (webhook/update):
	•	backend получает update об успешной оплате,
	•	проводит транзакцию:
	•	записывает Payment (status=paid),
	•	создаёт Donation,
	•	начисляет tons пользователю,
	•	обновляет агрегаты (или оставляет на вычисление запросами).

7.4 Идемпотентность

Повторный апдейт/дубли:
	•	платежи должны иметь уникальный payment_id/invoice_id
	•	при повторе: не начислять второй раз

⸻

8. Курс Stars → тоны

8.1 Требование

Курс не 1:1, должен подтягиваться из внешнего источника (“откуда-то”).

8.2 Реализация (требования)
	•	Модуль RateProvider:
	•	метод get_rate() → возвращает коэффициент tons_per_star
	•	Кеширование:
	•	хранить актуальный курс с TTL (например, 5–60 минут — настраивается)
	•	Фолбэк:
	•	если источник недоступен: использовать последний сохраненный курс
	•	если курса нет вообще: использовать дефолт (например, 1) и логировать критично

8.3 Формула начисления

tons_amount = stars_amount * tons_per_star
Округление: определить правило (например, до целых тонов, банковское/вниз/вверх) — лучше “до целых вниз” или “математика до целого” (настраиваемо).

⸻

9. База данных (минимальная схема)

9.1 users
	•	tg_id (PK, bigint)
	•	username (text, nullable)
	•	first_name (text, nullable)
	•	photo_url (text, nullable)
	•	created_at (timestamp)
	•	referrer_id (bigint, FK users.tg_id, nullable)
	•	is_blocked (bool, default false)

Индексы:
	•	referrer_id

9.2 donations
	•	id (uuid/bigserial PK)
	•	tg_id (FK users)
	•	stars_amount (int)
	•	tons_amount (numeric/int)
	•	created_at (timestamp)
	•	week_key (text/int) — для ускорения недельной агрегации (например, “2026-W03”)

Индексы:
	•	(created_at)
	•	(week_key)
	•	(tg_id, week_key)

9.3 payments
	•	id (uuid/bigserial)
	•	tg_id (FK users)
	•	invoice_id / telegram_payment_charge_id (unique)
	•	stars_amount (int)
	•	status (created/paid/failed)
	•	created_at, paid_at
	•	raw_payload (jsonb) — опционально для аудита

9.4 settings (опционально)
	•	key
	•	value_json
Для:
	•	preset amounts
	•	tons rounding rule
	•	timezone/week logic params
	•	rate provider params

⸻

10. API (backend)

10.1 Авторизация
	•	через Telegram initData (проверка подписи на backend)
	•	tg_id берём только из валидированного initData

10.2 Эндпоинты

GET /leaderboard/all-time?limit=&offset=
	•	returns: list {rank, tg_id, username, photo_url, tons_total}

GET /leaderboard/week?week_key=&limit=&offset=
	•	week_key опционально, по умолчанию текущая неделя
	•	returns: list {rank, tg_id, username, photo_url, tons_week}

GET /leaderboard/referrals?limit=&offset=
	•	returns: list {rank, tg_id, username, photo_url, referrals_count, referrals_tons_total}

GET /me
	•	returns: мои показатели:
	•	my tons all-time/week
	•	my referral stats
	•	my referral link

POST /payments/create-invoice
	•	body: {stars_amount, preset_id?}
	•	returns: {invoice_payload/slug/url} (в зависимости от Stars flow)

POST /referral/attach (опционально)
	•	обычно не нужен, если attach происходит при первом /me
	•	но можно сделать явное подтверждение:
	•	body: {referrer_id}
	•	backend применяет правило “только если новый пользователь”

⸻

11. Логика “первого входа”

При первом запросе пользователя (например, /me):
	1.	backend валидирует initData → tg_id
	2.	если user отсутствует — создать
	3.	если есть ref_code:
	•	если user создан сейчас (новый) и referrer_id пуст:
	•	if ref_code != tg_id и ref_code существует (или допускаем “пока не существует” — лучше требовать существование):
	•	set referrer_id = ref_code

⸻

12. Нефункциональные требования
	•	Время ответа leaderboard: до 300–500 мс на типовых объемах (кешировать топы можно)
	•	Логи: платежи, ошибки курса, attach ref
	•	Защита:
	•	обязательная валидация Telegram initData
	•	лимиты на create_invoice (rate limit)
	•	Масштабирование:
	•	кеш Redis (опционально) для лидербордов и курса

⸻

13. Edge cases
	•	Пользователь попытался пригласить сам себя → игнор
	•	Пользователь открыл по ref, но уже есть в базе → игнор
	•	Платёж “paid”, но ошибка записи в БД → ретраи/очередь, обязательно идемпотентность
	•	Курс недоступен → фолбэк на последний

⸻

14. Что нужно от вас как входные параметры (без “созвонов”, просто список)

Я не буду тянуть время вопросами, но чтобы ТЗ было “закрытым”, нужны 4 значения:
	1.	Пакеты Stars для “1/2/3 место” (например: 100 / 50 / 25 Stars)
	2.	Источник курса (URL/API/таблица/ручная админка). Если пока неизвестно — закладываем интерфейс RateProvider и временно “ручной курс из settings”.
	3.	Округление тонов: до целых? до 2 знаков?
	4.	Показ топов: N=50? N=100? и нужна ли “моя позиция” отдельным блоком?
